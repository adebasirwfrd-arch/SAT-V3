<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìà SAT-V3 Superchart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            overflow: hidden;
        }

        #chart-container {
            width: 100%;
            height: calc(100vh - 48px);
            margin-top: 48px;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: #1e222d;
            border-bottom: 1px solid #363c4e;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 8px;
            z-index: 100;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
            border-right: 1px solid #363c4e;
        }

        .toolbar-section:last-child {
            border-right: none;
            margin-left: auto;
        }

        .symbol-selector {
            padding: 6px 10px;
            border-radius: 4px;
            background: #2a2e39;
            color: #fff;
            border: 1px solid #363c4e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .symbol-selector:hover {
            border-color: #667eea;
        }

        .toolbar-btn {
            padding: 6px 10px;
            border-radius: 4px;
            background: #2a2e39;
            color: #9ca3af;
            border: 1px solid transparent;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .toolbar-btn:hover,
        .toolbar-btn.active {
            background: #364156;
            color: #fff;
            border-color: #667eea;
        }

        .toolbar-btn.active {
            background: #667eea;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            margin-left: 8px;
        }

        .info-panel {
            position: fixed;
            top: 56px;
            left: 12px;
            background: rgba(30, 34, 45, 0.95);
            border: 1px solid #363c4e;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 12px;
            z-index: 50;
            min-width: 200px;
            display: none;
        }

        .info-panel.visible {
            display: block;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .info-label {
            color: #9ca3af;
        }

        .info-value {
            font-weight: 600;
            font-family: monospace;
        }

        .info-value.up {
            color: #26a69a;
        }

        .info-value.down {
            color: #ef5350;
        }

        .loading-overlay {
            position: fixed;
            top: 48px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(19, 23, 34, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            font-size: 16px;
            color: #667eea;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .indicator-dropdown {
            position: relative;
        }

        .indicator-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e222d;
            border: 1px solid #363c4e;
            border-radius: 6px;
            padding: 4px 0;
            min-width: 160px;
            display: none;
            z-index: 200;
        }

        .indicator-menu.visible {
            display: block;
        }

        .indicator-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator-item:hover {
            background: #2a2e39;
        }

        .indicator-item .check {
            color: #26a69a;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <!-- Symbol & Timeframe -->
        <div class="toolbar-section">
            <select id="symbol-selector" class="symbol-selector">
                <option value="BTC/USDT">BTC/USDT</option>
                <option value="ETH/USDT">ETH/USDT</option>
                <option value="SOL/USDT">SOL/USDT</option>
                <option value="BNB/USDT">BNB/USDT</option>
                <option value="TON/USDT">TON/USDT</option>
                <option value="XRP/USDT">XRP/USDT</option>
            </select>
        </div>

        <!-- Timeframes -->
        <div class="toolbar-section">
            <button class="toolbar-btn" data-tf="1m">1m</button>
            <button class="toolbar-btn" data-tf="5m">5m</button>
            <button class="toolbar-btn" data-tf="15m">15m</button>
            <button class="toolbar-btn active" data-tf="1h">1H</button>
            <button class="toolbar-btn" data-tf="4h">4H</button>
            <button class="toolbar-btn" data-tf="1d">1D</button>
        </div>

        <!-- Chart Types -->
        <div class="toolbar-section">
            <button class="toolbar-btn active" data-type="candle" title="Candlestick">üïØÔ∏è</button>
            <button class="toolbar-btn" data-type="line" title="Line">üìà</button>
            <button class="toolbar-btn" data-type="area" title="Area">üìä</button>
        </div>

        <!-- Indicators -->
        <div class="toolbar-section indicator-dropdown">
            <button class="toolbar-btn" id="indicator-btn">üìâ Indicators</button>
            <div class="indicator-menu" id="indicator-menu">
                <div class="indicator-item" data-indicator="sma20">
                    SMA 20 <span class="check" id="check-sma20"></span>
                </div>
                <div class="indicator-item" data-indicator="sma50">
                    SMA 50 <span class="check" id="check-sma50"></span>
                </div>
                <div class="indicator-item" data-indicator="sma200">
                    SMA 200 <span class="check" id="check-sma200"></span>
                </div>
                <div class="indicator-item" data-indicator="ema12">
                    EMA 12 <span class="check" id="check-ema12"></span>
                </div>
                <div class="indicator-item" data-indicator="ema26">
                    EMA 26 <span class="check" id="check-ema26"></span>
                </div>
                <div class="indicator-item" data-indicator="bb">
                    Bollinger Bands <span class="check" id="check-bb"></span>
                </div>
            </div>
        </div>

        <!-- Zoom Controls -->
        <div class="toolbar-section">
            <button class="toolbar-btn" id="zoom-in" title="Zoom In">üîç+</button>
            <button class="toolbar-btn" id="zoom-out" title="Zoom Out">üîç-</button>
            <button class="toolbar-btn" id="zoom-reset" title="Fit All">‚ü≤</button>
        </div>

        <!-- Right side -->
        <div class="toolbar-section">
            <span id="chart-title" class="chart-title">BTC/USDT ‚Ä¢ 1H</span>
            <button class="toolbar-btn" id="fullscreen-btn" title="Fullscreen">‚õ∂</button>
        </div>
    </div>

    <!-- Crosshair Info Panel -->
    <div class="info-panel" id="info-panel">
        <div class="info-row">
            <span class="info-label">Time:</span>
            <span class="info-value" id="info-time">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Open:</span>
            <span class="info-value" id="info-open">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">High:</span>
            <span class="info-value" id="info-high">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Low:</span>
            <span class="info-value" id="info-low">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Close:</span>
            <span class="info-value" id="info-close">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Volume:</span>
            <span class="info-value" id="info-volume">-</span>
        </div>
    </div>

    <div id="chart-container"></div>
    <div id="loading-overlay" class="loading-overlay">Loading chart data...</div>

    <script>
        // =============================================
        // GLOBAL STATE
        // =============================================
        let chart, mainSeries, volumeSeries;
        let currentSymbol = 'BTC/USDT';
        let currentTimeframe = '1h';
        let currentChartType = 'candle';
        let rawData = [];

        // Indicator state
        const indicators = {
            sma20: { enabled: false, series: null, color: '#f0b90b' },
            sma50: { enabled: false, series: null, color: '#42a5f5' },
            sma200: { enabled: false, series: null, color: '#ab47bc' },
            ema12: { enabled: false, series: null, color: '#26a69a' },
            ema26: { enabled: false, series: null, color: '#ef5350' },
            bb: { enabled: false, series: { upper: null, middle: null, lower: null }, color: '#9e9e9e' }
        };

        // Parse initial symbol from URL
        const urlParams = new URLSearchParams(window.location.search);
        const symFromUrl = urlParams.get('symbol');
        if (symFromUrl) currentSymbol = symFromUrl;

        // =============================================
        // CHART INITIALIZATION
        // =============================================
        function initChart() {
            const container = document.getElementById('chart-container');

            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: '#758696', style: 2 },
                    horzLine: { color: '#758696', style: 2 },
                },
                rightPriceScale: { borderColor: '#363c4e' },
                timeScale: { borderColor: '#363c4e', timeVisible: true, secondsVisible: false },
            });

            // Create main series based on type
            createMainSeries();

            // Volume series
            volumeSeries = chart.addHistogramSeries({
                color: '#26a6a940',
                priceFormat: { type: 'volume' },
                priceScaleId: '',
                scaleMargins: { top: 0.85, bottom: 0 },
            });

            // Crosshair subscription
            chart.subscribeCrosshairMove(handleCrosshairMove);

            // Resize handler
            window.addEventListener('resize', () => {
                chart.applyOptions({
                    width: container.clientWidth,
                    height: container.clientHeight,
                });
            });

            // Load initial data
            loadSymbol(currentSymbol, currentTimeframe);
        }

        function createMainSeries() {
            if (mainSeries) {
                chart.removeSeries(mainSeries);
            }

            if (currentChartType === 'candle') {
                mainSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderDownColor: '#ef5350',
                    borderUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                    wickUpColor: '#26a69a',
                });
            } else if (currentChartType === 'line') {
                mainSeries = chart.addLineSeries({
                    color: '#2962ff',
                    lineWidth: 2,
                });
            } else if (currentChartType === 'area') {
                mainSeries = chart.addAreaSeries({
                    topColor: 'rgba(41, 98, 255, 0.5)',
                    bottomColor: 'rgba(41, 98, 255, 0.1)',
                    lineColor: '#2962ff',
                    lineWidth: 2,
                });
            }
        }

        // =============================================
        // DATA LOADING
        // =============================================
        async function loadSymbol(symbol, timeframe) {
            showLoading();
            currentSymbol = symbol;
            currentTimeframe = timeframe;

            try {
                const safeSym = symbol.replace('/', '-');
                const response = await fetch(`/api/ohlcv/${safeSym}?timeframe=${timeframe}&limit=1000`);
                const data = await response.json();

                if (data && data.length > 0) {
                    rawData = data;

                    // Format and set data based on chart type
                    if (currentChartType === 'candle') {
                        const candles = data.map(d => ({
                            time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
                        }));
                        mainSeries.setData(candles);
                    } else {
                        const lineData = data.map(d => ({ time: d.time, value: d.close }));
                        mainSeries.setData(lineData);
                    }

                    // Volume
                    const volumes = data.map(d => ({
                        time: d.time, value: d.volume,
                        color: d.close >= d.open ? '#26a69a40' : '#ef535040',
                    }));
                    volumeSeries.setData(volumes);

                    // Update indicators
                    updateIndicators();

                    chart.timeScale().fitContent();
                    document.getElementById('chart-title').textContent = `${symbol} ‚Ä¢ ${timeframe.toUpperCase()}`;
                    console.log(`[Chart] Loaded ${data.length} candles for ${symbol} ${timeframe}`);
                }
            } catch (err) {
                console.error('[Chart] Error loading data:', err);
            }

            hideLoading();
        }

        // =============================================
        // INDICATORS
        // =============================================
        function calculateSMA(data, period) {
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - period + 1, i + 1);
                const sum = slice.reduce((a, b) => a + b.close, 0);
                result.push({ time: data[i].time, value: sum / period });
            }
            return result;
        }

        function calculateEMA(data, period) {
            const result = [];
            const k = 2 / (period + 1);
            let ema = data.slice(0, period).reduce((a, b) => a + b.close, 0) / period;
            result.push({ time: data[period - 1].time, value: ema });

            for (let i = period; i < data.length; i++) {
                ema = data[i].close * k + ema * (1 - k);
                result.push({ time: data[i].time, value: ema });
            }
            return result;
        }

        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            const upper = [], middle = [], lower = [];
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b.close, 0) / period;
                const variance = slice.reduce((a, b) => a + Math.pow(b.close - mean, 2), 0) / period;
                const std = Math.sqrt(variance);

                middle.push({ time: data[i].time, value: mean });
                upper.push({ time: data[i].time, value: mean + stdDev * std });
                lower.push({ time: data[i].time, value: mean - stdDev * std });
            }
            return { upper, middle, lower };
        }

        function updateIndicators() {
            if (rawData.length === 0) return;

            // SMA 20
            if (indicators.sma20.enabled) {
                if (!indicators.sma20.series) {
                    indicators.sma20.series = chart.addLineSeries({ color: indicators.sma20.color, lineWidth: 1 });
                }
                indicators.sma20.series.setData(calculateSMA(rawData, 20));
            } else if (indicators.sma20.series) {
                chart.removeSeries(indicators.sma20.series);
                indicators.sma20.series = null;
            }

            // SMA 50
            if (indicators.sma50.enabled) {
                if (!indicators.sma50.series) {
                    indicators.sma50.series = chart.addLineSeries({ color: indicators.sma50.color, lineWidth: 1 });
                }
                indicators.sma50.series.setData(calculateSMA(rawData, 50));
            } else if (indicators.sma50.series) {
                chart.removeSeries(indicators.sma50.series);
                indicators.sma50.series = null;
            }

            // SMA 200
            if (indicators.sma200.enabled) {
                if (!indicators.sma200.series) {
                    indicators.sma200.series = chart.addLineSeries({ color: indicators.sma200.color, lineWidth: 1 });
                }
                indicators.sma200.series.setData(calculateSMA(rawData, 200));
            } else if (indicators.sma200.series) {
                chart.removeSeries(indicators.sma200.series);
                indicators.sma200.series = null;
            }

            // EMA 12
            if (indicators.ema12.enabled) {
                if (!indicators.ema12.series) {
                    indicators.ema12.series = chart.addLineSeries({ color: indicators.ema12.color, lineWidth: 1 });
                }
                indicators.ema12.series.setData(calculateEMA(rawData, 12));
            } else if (indicators.ema12.series) {
                chart.removeSeries(indicators.ema12.series);
                indicators.ema12.series = null;
            }

            // EMA 26
            if (indicators.ema26.enabled) {
                if (!indicators.ema26.series) {
                    indicators.ema26.series = chart.addLineSeries({ color: indicators.ema26.color, lineWidth: 1 });
                }
                indicators.ema26.series.setData(calculateEMA(rawData, 26));
            } else if (indicators.ema26.series) {
                chart.removeSeries(indicators.ema26.series);
                indicators.ema26.series = null;
            }

            // Bollinger Bands
            if (indicators.bb.enabled) {
                const bb = calculateBollingerBands(rawData);
                if (!indicators.bb.series.upper) {
                    indicators.bb.series.upper = chart.addLineSeries({ color: indicators.bb.color, lineWidth: 1, lineStyle: 2 });
                    indicators.bb.series.middle = chart.addLineSeries({ color: indicators.bb.color, lineWidth: 1 });
                    indicators.bb.series.lower = chart.addLineSeries({ color: indicators.bb.color, lineWidth: 1, lineStyle: 2 });
                }
                indicators.bb.series.upper.setData(bb.upper);
                indicators.bb.series.middle.setData(bb.middle);
                indicators.bb.series.lower.setData(bb.lower);
            } else if (indicators.bb.series.upper) {
                chart.removeSeries(indicators.bb.series.upper);
                chart.removeSeries(indicators.bb.series.middle);
                chart.removeSeries(indicators.bb.series.lower);
                indicators.bb.series = { upper: null, middle: null, lower: null };
            }
        }

        function toggleIndicator(name) {
            indicators[name].enabled = !indicators[name].enabled;
            document.getElementById(`check-${name}`).textContent = indicators[name].enabled ? '‚úì' : '';
            updateIndicators();
        }

        // =============================================
        // CROSSHAIR INFO PANEL
        // =============================================
        function handleCrosshairMove(param) {
            const panel = document.getElementById('info-panel');
            if (!param.time || !param.seriesData.get(mainSeries)) {
                panel.classList.remove('visible');
                return;
            }

            panel.classList.add('visible');
            const data = param.seriesData.get(mainSeries);
            const volumeData = param.seriesData.get(volumeSeries);

            const date = new Date(param.time * 1000);
            document.getElementById('info-time').textContent = date.toLocaleString();

            if (currentChartType === 'candle') {
                const isUp = data.close >= data.open;
                document.getElementById('info-open').textContent = data.open?.toFixed(2) || '-';
                document.getElementById('info-high').textContent = data.high?.toFixed(2) || '-';
                document.getElementById('info-low').textContent = data.low?.toFixed(2) || '-';
                const closeEl = document.getElementById('info-close');
                closeEl.textContent = data.close?.toFixed(2) || '-';
                closeEl.className = `info-value ${isUp ? 'up' : 'down'}`;
            } else {
                document.getElementById('info-open').textContent = '-';
                document.getElementById('info-high').textContent = '-';
                document.getElementById('info-low').textContent = '-';
                document.getElementById('info-close').textContent = data.value?.toFixed(2) || '-';
            }

            document.getElementById('info-volume').textContent = volumeData?.value?.toLocaleString() || '-';
        }

        // =============================================
        // UTILITIES
        // =============================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // =============================================
        // EVENT HANDLERS
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial dropdown value
            document.getElementById('symbol-selector').value = currentSymbol;

            // Create chart
            initChart();

            // Symbol selector
            document.getElementById('symbol-selector').addEventListener('change', (e) => {
                loadSymbol(e.target.value, currentTimeframe);
            });

            // Timeframe buttons
            document.querySelectorAll('[data-tf]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadSymbol(currentSymbol, e.target.dataset.tf);
                });
            });

            // Chart type buttons
            document.querySelectorAll('[data-type]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentChartType = e.target.dataset.type;
                    createMainSeries();
                    loadSymbol(currentSymbol, currentTimeframe);
                });
            });

            // Indicator menu toggle
            document.getElementById('indicator-btn').addEventListener('click', () => {
                document.getElementById('indicator-menu').classList.toggle('visible');
            });

            // Indicator items
            document.querySelectorAll('[data-indicator]').forEach(item => {
                item.addEventListener('click', (e) => {
                    toggleIndicator(e.currentTarget.dataset.indicator);
                });
            });

            // Close indicator menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.indicator-dropdown')) {
                    document.getElementById('indicator-menu').classList.remove('visible');
                }
            });

            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                chart.timeScale().zoomScale(1.5);
            });
            document.getElementById('zoom-out').addEventListener('click', () => {
                chart.timeScale().zoomScale(0.67);
            });
            document.getElementById('zoom-reset').addEventListener('click', () => {
                chart.timeScale().fitContent();
            });

            // Fullscreen
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        });
    </script>
</body>

</html>
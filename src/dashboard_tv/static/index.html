<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî± SAT-V3 Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0D0E12;
            color: #E0E6ED;
            padding: 1rem;
        }

        .container {
            max-width: 1800px;
            margin: auto;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .card {
            background: #1E222D;
            border-radius: 10px;
            padding: 0.75rem;
            border: 1px solid #2A2E39;
        }

        .card:hover {
            border-color: #667eea;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .coin-name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .price {
            font-size: 0.9rem;
        }

        .price-change {
            font-size: 0.75rem;
            margin-left: 0.2rem;
        }

        .score {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin: 0.3rem 0;
        }

        .score.bullish {
            color: #26a69a;
        }

        .score.bearish {
            color: #ef5350;
        }

        .score.neutral {
            color: #ffa726;
        }

        .signal {
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .params {
            font-size: 0.7rem;
            margin: 0.3rem 0;
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            margin: 0.2rem 0;
        }

        .council {
            font-size: 0.6rem;
            margin-top: 0.3rem;
            padding-top: 0.3rem;
            border-top: 1px solid #2A2E39;
        }

        .council-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: #9CA3AF;
        }

        .council-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.15rem;
        }

        .council-item {
            padding: 0.1rem 0.2rem;
            border-radius: 2px;
            background: #2A2E39;
            font-size: 0.55rem;
        }

        .mini-chart-container {
            height: 50px;
            margin-top: 0.3rem;
            background: #151820;
            border-radius: 3px;
        }

        .osc-container {
            height: 30px;
            margin-top: 0.2rem;
            background: #151820;
            border-radius: 3px;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.2rem;
            margin-top: 0.3rem;
        }

        button {
            padding: 0.4rem;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .buy-btn {
            background: #26a69a;
            color: #fff;
        }

        .buy-btn:hover {
            background: #20897d;
        }

        .sell-btn {
            background: #ef5350;
            color: #fff;
        }

        .sell-btn:hover {
            background: #e53935;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .portfolio-card {
            background: linear-gradient(135deg, #1a1f2e 0%, #252b3d 100%);
            border: 1px solid #3a4050;
        }

        .portfolio-title {
            font-size: 1rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .portfolio-equity {
            font-size: 1.6rem;
            font-weight: 700;
            color: #26a69a;
            text-align: center;
            margin: 0.5rem 0;
        }

        .portfolio-params {
            font-size: 0.75rem;
        }

        .portfolio-param {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            border-bottom: 1px solid #2A2E39;
        }

        .portfolio-param:last-child {
            border-bottom: none;
        }

        .profit {
            color: #26a69a;
        }

        .loss {
            color: #ef5350;
        }

        /* Transaction Card */
        .tx-card {
            max-height: 200px;
            overflow-y: auto;
        }

        .tx-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #ff9800;
            margin-bottom: 0.5rem;
        }

        .tx-item {
            display: grid;
            grid-template-columns: 70px 1fr 80px;
            gap: 0.3rem;
            padding: 0.4rem;
            background: #151820;
            border-radius: 4px;
            margin-bottom: 0.3rem;
            font-size: 0.7rem;
        }

        .tx-symbol {
            font-weight: 700;
        }

        .tx-details {
            color: #9CA3AF;
        }

        .tx-pnl {
            text-align: right;
            font-weight: 600;
        }

        /* AI Log Card */
        .log-card {
            max-height: 150px;
            overflow-y: auto;
        }

        .log-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #00bcd4;
            margin-bottom: 0.5rem;
        }

        .log-item {
            padding: 0.3rem 0.4rem;
            background: #151820;
            border-radius: 3px;
            margin-bottom: 0.2rem;
            font-size: 0.65rem;
            font-family: monospace;
        }

        .log-time {
            color: #667eea;
            margin-right: 0.5rem;
        }

        .log-trade {
            color: #26a69a;
        }

        .log-price {
            color: #ffa726;
        }

        .tx-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            margin-right: 4px;
        }

        .badge-bot {
            background: #673ab7;
            color: white;
        }

        .badge-manual {
            background: #009688;
            color: white;
        }

        .tx-action-btn {
            background: #ef5350;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.65rem;
            margin-left: 5px;
        }

        .tx-action-btn:hover {
            background: #c62828;
        }

        .liquidate-btn {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.7rem;
            cursor: pointer;
            float: right;
        }

        .liquidate-btn:hover {
            background: #b71c1c;
        }

        /* Chart Section */
        .chart-section {
            background: #1E222D;
            border-radius: 10px;
            padding: 0.75rem;
            border: 1px solid #2A2E39;
            margin-bottom: 0.75rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .chart-header h2 {
            font-size: 0.9rem;
            color: #9CA3AF;
        }

        .open-superchart-btn {
            padding: 0.4rem 0.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .superchart-iframe {
            width: 100%;
            height: 450px;
            border: none;
            border-radius: 6px;
        }

        /* Status Bar */
        .status-bar {
            text-align: center;
            padding: 0.4rem;
            background: #1E222D;
            border-radius: 5px;
            font-size: 0.75rem;
            color: #9CA3AF;
        }

        .live-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #26a69a;
            border-radius: 50%;
            margin-right: 0.4rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="top-section">
            <div class="cards-grid" id="cards"></div>
            <div class="right-panel">
                <!-- Portfolio Card -->
                <div class="card portfolio-card">
                    <div class="portfolio-title">
                        üíº Portfolio
                        <button class="liquidate-btn" onclick="liquidateAll()">üí• Liquidate All</button>
                    </div>
                    <div class="portfolio-equity" id="portfolio-equity">$100,000.00</div>
                    <div class="portfolio-params">
                        <div class="portfolio-param"><span>Cash:</span><strong id="cash">$100,000.00</strong></div>
                        <div class="portfolio-param"><span>Equity:</span><strong id="equity">$100,000.00</strong></div>
                        <div class="portfolio-param"><span>Realized PnL:</span><strong id="realized-pnl"
                                class="profit">$0.00</strong></div>
                        <div class="portfolio-param"><span>Unrealized PnL:</span><strong id="unrealized-pnl"
                                class="profit">$0.00</strong></div>
                        <div class="portfolio-param"><span>Max Drawdown:</span><strong id="max-drawdown"
                                class="loss">0.00%</strong></div>
                        <div class="portfolio-param"><span>Open Positions:</span><strong id="open-positions">0</strong>
                        </div>
                    </div>

                    <!-- Strategy Toggle -->
                    <div style="margin-top: 0.75rem; border-top: 1px solid #363c4e; padding-top: 0.75rem;">
                        <div style="font-size: 0.75rem; color: #9CA3AF; margin-bottom: 0.4rem; font-weight: 600;">üéØ
                            Trading Strategy</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem;">
                            <button id="btn-7council" class="strategy-btn"
                                style="padding: 0.5rem; border: 2px solid #667eea; background: #667eea; color: #fff; border-radius: 5px; font-weight: 600; font-size: 0.7rem; cursor: pointer;"
                                onclick="setStrategy('7council')">
                                7 Council
                            </button>
                            <button id="btn-entrylogic" class="strategy-btn"
                                style="padding: 0.5rem; border: 2px solid #363c4e; background: transparent; color: #9CA3AF; border-radius: 5px; font-weight: 600; font-size: 0.7rem; cursor: pointer;"
                                onclick="setStrategy('entrylogic')">
                                Entry Logic
                            </button>
                        </div>
                        <div id="strategy-status"
                            style="margin-top: 0.4rem; font-size: 0.65rem; color: #667eea; text-align: center;">7
                            Council (Consensus Voting)</div>
                        <div id="bot-strategy-indicator"
                            style="margin-top: 0.5rem; padding: 0.4rem; background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; border-radius: 5px; text-align: center;">
                            <div style="font-size: 0.65rem; color: #9CA3AF; margin-bottom: 0.2rem;">ü§ñ AI Bot Strategy:
                            </div>
                            <div id="bot-strategy-name" style="font-size: 0.75rem; font-weight: 700; color: #667eea;">7
                                COUNCIL</div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details Card -->
                <div class="card tx-card">
                    <div class="tx-title">üìä Active Positions</div>
                    <div id="positions-list">
                        <div style="color:#9CA3AF;font-size:0.7rem;text-align:center;">No active positions</div>
                    </div>
                </div>

                <!-- AI Bot Log Card -->
                <div class="card log-card">
                    <div class="log-title">ü§ñ AI Bot Log</div>
                    <div id="log-list">
                        <div class="log-item"><span class="log-time">--:--:--</span> Waiting for activity...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                <h2>üìà Live Chart</h2>
                <a href="/chart" id="superchart-link" class="open-superchart-btn" target="_blank">üöÄ Open Superchart</a>
            </div>
            <iframe src="/chart" class="superchart-iframe" allowfullscreen></iframe>
        </div>

        <!-- Real-Time Price Log -->
        <div class="card" style="margin-bottom:0.75rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <div class="log-title" style="margin:0;">üì° Real-Time Price Feed (Binance Testnet)</div>
                <div id="price-count" style="font-size:0.7rem;color:#9CA3AF;">0 updates</div>
            </div>
            <div id="price-log-list" style="max-height:120px;overflow-y:auto;font-family:monospace;">
                <div class="log-item"><span class="log-time">--:--:--</span> Connecting to Binance Testnet...</div>
            </div>
        </div>

        <div class="status-bar">
            <span class="live-indicator"></span>
            <span id="status">Connecting...</span>
        </div>
    </div>

    <script>
        let ws;
        const councilNames = ["Trend", "Structure", "Volume", "Smart Money", "Pattern", "Geometry", "Indicator"];
        const miniCharts = {};
        const oscCharts = {};
        let previousCoins = [];



        function createCard(coin, info) {
            const score = info.council_score || 50;
            const signal = info.signal || 'NEUTRAL';
            const scoreClass = score >= 60 ? 'bullish' : score <= 40 ? 'bearish' : 'neutral';
            const priceChange = info.price_change || 0;
            const councilScores = councilNames.map(() => (Math.random() * 100).toFixed(2));

            // Check active strategy (from global state or button state)
            const isEntryLogic = document.getElementById('btn-entrylogic')?.style?.background === 'rgb(102, 126, 234)';

            // Build council section (7 Council mode)
            const councilSection = `
                <div class="council">
                    <div class="council-title">‚öîÔ∏è 7 Council</div>
                    <div class="council-row">
                        ${councilNames.map((name, i) => {
                const s = parseFloat(councilScores[i]);
                const emoji = s >= 60 ? 'üü¢' : s <= 40 ? 'üî¥' : 'üü°';
                return `<div class="council-item">${emoji} ${name}: ${councilScores[i]}</div>`;
            }).join('')}
                    </div>
                </div>`;

            // Build Entry Logic section
            const entryLogic = info.entry_logic || {};
            const entryLogicSection = `
                <div class="council">
                    <div class="council-title">üéØ Entry Logic + Double Tap</div>
                    <div class="params" style="margin-top: 8px;">
                        <div class="param-row"><span>Swing Low:</span><strong>$${entryLogic.swing_low || '0.00'}</strong></div>
                        <div class="param-row"><span>Liq. Sweep:</span><strong style="color:${entryLogic.liquidity_sweep ? '#26a69a' : '#9CA3AF'}">${entryLogic.liquidity_sweep ? '‚úÖ YES' : '‚ùå NO'}</strong></div>
                        <div class="param-row"><span>RSI Div:</span><strong style="color:${entryLogic.rsi_divergence ? '#26a69a' : '#9CA3AF'}">${entryLogic.rsi_divergence ? '‚úÖ YES' : '‚ùå NO'}</strong></div>
                        <div class="param-row"><span>Entry Signal:</span><strong style="color:${entryLogic.entry_detected ? '#26a69a' : '#ffa726'}">${info.entry_logic_signal || 'WAITING'}</strong></div>
                        ${entryLogic.entry_detected ? `
                            <div class="param-row"><span>Entry Price:</span><strong style="color:#667eea">$${entryLogic.entry_price}</strong></div>
                            <div class="param-row"><span>Stop Loss:</span><strong style="color:#ef5350">$${entryLogic.stop_loss}</strong></div>
                        ` : ''}
                        <div style="margin-top:8px;border-top:1px solid #363c4e;padding-top:8px;">
                            <div class="param-row"><span>üéÆ Game Theory:</span><strong style="color:${entryLogic.game_theory_status === 'DOUBLE TAP' ? '#26a69a' : entryLogic.game_theory_status === 'ACTIVE' ? '#ffa726' : '#9CA3AF'}">${entryLogic.game_theory_status || 'STANDBY'}</strong></div>
                            <div class="param-row"><span>Attempts:</span><strong style="color:${entryLogic.attempt_count >= 2 ? '#ef5350' : entryLogic.attempt_count >= 1 ? '#ffa726' : '#26a69a'}">${entryLogic.attempt_count || 0}/${entryLogic.max_attempts || 2}</strong></div>
                            <div class="param-row"><span>Last Trade:</span><strong style="color:${entryLogic.last_trade_result === 'WIN' ? '#26a69a' : entryLogic.last_trade_result === 'LOSS' ? '#ef5350' : '#9CA3AF'}">${entryLogic.last_trade_result || 'NONE'}</strong></div>
                            <div class="param-row"><span>Entry Type:</span><strong style="color:${entryLogic.entry_type === 'REVENGE_ENTRY' ? '#667eea' : '#9CA3AF'}">${entryLogic.entry_type || 'NORMAL'}</strong></div>
                        </div>
                    </div>
                </div>`;

            return `
                <div class="card" data-coin="${coin}">
                    <div class="card-header">
                        <span class="coin-name">${coin}</span>
                        <span class="price">$${info.price?.toFixed(2) || '0.00'}
                            <span class="price-change" style="color:${priceChange >= 0 ? '#26a69a' : '#ef5350'}">
                                ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%
                            </span>
                        </span>
                    </div>
                    <div class="score ${scoreClass}">${score.toFixed(2)}</div>
                    <div class="signal ${scoreClass}">${signal}</div>
                    <div class="params">
                        <div class="param-row"><span>RSI:</span><strong>${info.rsi?.toFixed(2) || '0.00'}</strong></div>
                        <div class="param-row"><span>ATR:</span><strong>${info.atr?.toFixed(2) || '0.00'}</strong></div>
                        <div class="param-row"><span>Sentiment:</span><strong style="color:${info.sentiment === 'HYPE' ? '#26a69a' : info.sentiment === 'FEAR' ? '#ef5350' : '#ffa726'}">${info.sentiment || 'NORMAL'}</strong></div>
                    </div>
                    ${isEntryLogic ? entryLogicSection : councilSection}
                    <div class="mini-chart-container" id="mini-${coin}"></div>
                    <div class="osc-container" id="osc-${coin}"></div>
                    <div class="buttons">
                        <button class="buy-btn" onclick="sendCommand('${info.symbol}','FORCE_BUY')">üü¢ BUY</button>
                        <button class="sell-btn" onclick="sendCommand('${info.symbol}','FORCE_SELL')">üî¥ SELL</button>
                    </div>
                </div>`;
        }

        function initMiniCharts(coins) {
            coins.forEach(coin => {
                const miniContainer = document.getElementById(`mini-${coin}`);
                if (miniContainer && !miniCharts[coin]) {
                    try {
                        const chart = LightweightCharts.createChart(miniContainer, {
                            width: miniContainer.clientWidth || 150,
                            height: 50,
                            layout: { background: { color: '#151820' }, textColor: '#9CA3AF' },
                            grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                            rightPriceScale: { visible: false },
                            timeScale: { visible: false },
                            crosshair: { mode: 0 }
                        });
                        const areaSeries = chart.addAreaSeries({
                            topColor: 'rgba(102, 126, 234, 0.5)',
                            bottomColor: 'rgba(102, 126, 234, 0.1)',
                            lineColor: '#667eea',
                            lineWidth: 1
                        });
                        miniCharts[coin] = { chart, series: areaSeries, data: [] };
                    } catch (e) { console.error('Mini chart error:', e); }
                }

                const oscContainer = document.getElementById(`osc-${coin}`);
                if (oscContainer && !oscCharts[coin]) {
                    try {
                        const oscChart = LightweightCharts.createChart(oscContainer, {
                            width: oscContainer.clientWidth || 150,
                            height: 30,
                            layout: { background: { color: '#151820' }, textColor: '#9CA3AF' },
                            grid: { vertLines: { visible: false }, horzLines: { visible: false } },
                            rightPriceScale: { visible: false },
                            timeScale: { visible: false },
                            crosshair: { mode: 0 }
                        });
                        const lineSeries = oscChart.addLineSeries({ color: '#ff9800', lineWidth: 1 });
                        oscCharts[coin] = { chart: oscChart, series: lineSeries, data: [] };
                    } catch (e) { console.error('Osc chart error:', e); }
                }
            });
        }

        function destroyAllCharts() {
            // Destroy all mini charts
            Object.keys(miniCharts).forEach(coin => {
                try {
                    if (miniCharts[coin] && miniCharts[coin].chart) {
                        miniCharts[coin].chart.remove();
                    }
                } catch (e) {
                    console.error('Error destroying mini chart:', e);
                }
            });

            // Destroy all oscillator charts
            Object.keys(oscCharts).forEach(coin => {
                try {
                    if (oscCharts[coin] && oscCharts[coin].chart) {
                        oscCharts[coin].chart.remove();
                    }
                } catch (e) {
                    console.error('Error destroying osc chart:', e);
                }
            });

            // Clear the objects
            Object.keys(miniCharts).forEach(key => delete miniCharts[key]);
            Object.keys(oscCharts).forEach(key => delete oscCharts[key]);
        }

        function updateMiniCharts(assets) {
            const now = Math.floor(Date.now() / 1000);
            Object.keys(assets).forEach(coin => {
                const price = assets[coin].price || 0;
                const score = assets[coin].council_score || 50;

                if (miniCharts[coin]) {
                    const mc = miniCharts[coin];
                    mc.data.push({ time: now, value: price });
                    if (mc.data.length > 60) mc.data.shift();
                    try { mc.series.setData(mc.data); } catch (e) { }
                }

                if (oscCharts[coin]) {
                    const oc = oscCharts[coin];
                    oc.data.push({ time: now, value: score });
                    if (oc.data.length > 60) oc.data.shift();
                    try { oc.series.setData(oc.data); } catch (e) { }
                }
            });
        }

        function sendCommand(symbol, action) {
            fetch(`/api/command/${symbol.replace('/', '-')}/${action}?source=MANUAL`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'ok') {
                        // Do not alert on success to avoid spamming enter key, just log or silent
                        // But user wants feedback probably.
                        console.log(`‚úÖ ${d.message}`);
                    } else {
                        alert(`‚ùå ${d.message}`);
                    }
                })
                .catch(e => alert(`‚ùå ${e.message}`));
        }

        function sellPosition(symbol) {
            if (confirm(`Are you sure you want to SELL ${symbol}?`)) {
                sendCommand(symbol, 'FORCE_SELL');
            }
        }

        function liquidateAll() {
            if (confirm('‚ö†Ô∏è WARNING: This will SELL ALL active positions immediately!\nAre you sure?')) {
                fetch('/api/liquidate_all', { method: 'POST' })
                    .then(r => r.json())
                    .then(d => alert(d.message))
                    .catch(e => alert(e.message));
            }
        }

        async function setStrategy(mode) {
            try {
                const response = await fetch(`/api/strategy/${mode}`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'ok') {
                    // Update button styles
                    const btn7 = document.getElementById('btn-7council');
                    const btnEntry = document.getElementById('btn-entrylogic');

                    if (mode === '7council') {
                        btn7.style.background = '#667eea';
                        btn7.style.borderColor = '#667eea';
                        btn7.style.color = '#fff';
                        btnEntry.style.background = 'transparent';
                        btnEntry.style.borderColor = '#363c4e';
                        btnEntry.style.color = '#9CA3AF';
                    } else {
                        btnEntry.style.background = '#667eea';
                        btnEntry.style.borderColor = '#667eea';
                        btnEntry.style.color = '#fff';
                        btn7.style.background = 'transparent';
                        btn7.style.borderColor = '#363c4e';
                        btn7.style.color = '#9CA3AF';
                    }

                    // Update status text and bot indicator
                    document.getElementById('strategy-status').textContent = data.name;
                    const botStrategyName = document.getElementById('bot-strategy-name');
                    const botStrategyIndicator = document.getElementById('bot-strategy-indicator');

                    if (mode === '7council') {
                        botStrategyName.textContent = '7 COUNCIL';
                        botStrategyIndicator.style.borderColor = '#667eea';
                        botStrategyIndicator.style.background = 'rgba(102, 126, 234, 0.1)';
                        botStrategyName.style.color = '#667eea';
                    } else {
                        botStrategyName.textContent = 'ENTRY LOGIC (DOUBLE TAP)';
                        botStrategyIndicator.style.borderColor = '#26a69a';
                        botStrategyIndicator.style.background = 'rgba(38, 166, 154, 0.1)';
                        botStrategyName.style.color = '#26a69a';
                    }

                    // Force card refresh to show new parameters
                    if (window.currentAssets && window.currentCoins) {
                        // CRITICAL: Destroy old charts before rebuilding cards
                        destroyAllCharts();
                        document.getElementById('cards').innerHTML = window.currentCoins.map(c => createCard(c, window.currentAssets[c])).join('');
                        setTimeout(() => initMiniCharts(window.currentCoins), 50);
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Strategy switch error:', error);
                alert('Failed to switch strategy');
            }
        }

        // Load current strategy on page load
        async function loadCurrentStrategy() {
            try {
                const response = await fetch('/api/strategy');
                const data = await response.json();
                setStrategy(data.active_strategy);
            } catch (error) {
                console.error('Failed to load strategy:', error);
            }
        }

        function updateTransactions(transactions) {
            const container = document.getElementById('positions-list');

            // Handle empty state
            if (!transactions || transactions.length === 0) {
                if (container.children.length !== 1 || !container.children[0].textContent.includes('No active positions')) {
                    container.innerHTML = '<div style="color:#9CA3AF;font-size:0.7rem;text-align:center;">No active positions</div>';
                }
                return;
            }

            // Remove "No active positions" if present
            if (container.children.length === 1 && container.children[0].textContent.includes('No active positions')) {
                container.innerHTML = '';
            }

            // Track active symbols to identify removals
            const activeInfos = new Map(transactions.map(t => [t.symbol, t]));

            // 1. Remove closed positions
            Array.from(container.children).forEach(child => {
                const sym = child.getAttribute('data-symbol');
                if (sym && !activeInfos.has(sym)) {
                    child.remove();
                }
            });

            // 2. Update or Create positions
            transactions.forEach(tx => {
                const symbol = tx.symbol;
                const safeSym = symbol.replace(/[^a-zA-Z0-9]/g, '-');
                let el = document.getElementById(`tx-${safeSym}`);

                const pnl = tx.pnl || 0;
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                const pnlStr = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
                const currentPrice = tx.current_price || tx.entry_price;
                const priceColor = currentPrice >= tx.entry_price ? '#26a69a' : '#ef5350';
                const source = tx.source || 'MANUAL';
                const badgeClass = source.includes('BOT') ? 'badge-bot' : 'badge-manual';
                const badgeIcon = source.includes('BOT') ? 'ü§ñ' : 'üë§';

                // Content for dynamic parts
                const detailsHTML = `${tx.quantity.toFixed(6)} @ $${tx.entry_price.toFixed(2)}
                                ‚Üí <span style="color:${priceColor}">$${currentPrice.toFixed(2)}</span>
                                ${tx.stop_loss ? `<br><span style="color:#ef5350;font-size:0.65rem;">üõë SL: $${tx.stop_loss.toFixed(2)}</span>` : ''}`;

                if (!el) {
                    // Create new row
                    el = document.createElement('div');
                    el.className = 'tx-item';
                    el.id = `tx-${safeSym}`;
                    el.setAttribute('data-symbol', symbol);
                    el.style.gridTemplateColumns = '80px 1fr 100px';

                    el.innerHTML = `
                        <div class="tx-symbol">
                            ${tx.symbol.replace('/USDT', '')}
                            <div style="margin-top:2px;">
                                <span class="tx-badge ${badgeClass}">${badgeIcon}</span>
                            </div>
                        </div>
                        <div class="tx-details">${detailsHTML}</div>
                        <div class="tx-pnl ${pnlClass}">
                            <span class="pnl-value">${pnlStr}</span>
                            <div style="margin-top:2px; text-align:right;">
                                <button class="tx-action-btn" onclick="sellPosition('${tx.symbol}')">Sell ‚ùå</button>
                            </div>
                        </div>`;
                    container.appendChild(el);
                } else {
                    // Update existing row
                    // Update Details
                    const detailsEl = el.querySelector('.tx-details');
                    if (detailsEl.innerHTML !== detailsHTML) {
                        detailsEl.innerHTML = detailsHTML;
                    }

                    // Update PnL Class and Value
                    const pnlEl = el.querySelector('.tx-pnl');
                    if (pnlEl.className !== `tx-pnl ${pnlClass}`) {
                        pnlEl.className = `tx-pnl ${pnlClass}`;
                    }
                    const pnlValueEl = el.querySelector('.pnl-value');
                    if (pnlValueEl && pnlValueEl.textContent !== pnlStr) {
                        pnlValueEl.textContent = pnlStr;
                    }
                }
            });
        }

        function updateBotLogs(logs) {
            const container = document.getElementById('log-list');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="log-item"><span class="log-time">--:--:--</span> Waiting for activity...</div>';
                return;
            }

            container.innerHTML = logs.slice(-20).reverse().map(log => {
                const time = log.timestamp ? log.timestamp.split(' ')[1] || log.timestamp : '--:--:--';
                const typeClass = log.type === 'TRADE' ? 'log-trade' : 'log-price';
                return `<div class="log-item"><span class="log-time">${time}</span> <span class="${typeClass}">${log.message}</span></div>`;
            }).join('');
        }

        let priceUpdateCount = 0;

        function updatePriceLogs(priceLogs) {
            const container = document.getElementById('price-log-list');
            if (!priceLogs || priceLogs.length === 0) {
                return;
            }

            priceUpdateCount += priceLogs.length;
            document.getElementById('price-count').textContent = `${priceUpdateCount} updates`;

            // Add new logs at top
            const newLogs = priceLogs.map(log => {
                const isUp = log.message.includes('üìà');
                const color = isUp ? '#26a69a' : '#ef5350';
                return `<div class="log-item"><span class="log-time">${log.timestamp}</span> <span style="color:${color}">${log.message}</span></div>`;
            }).join('');

            container.innerHTML = newLogs + container.innerHTML;

            // Keep only last 50 items
            const items = container.querySelectorAll('.log-item');
            if (items.length > 50) {
                for (let i = 50; i < items.length; i++) {
                    items[i].remove();
                }
            }
        }

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);
            ws.onopen = () => {
                document.getElementById('status').textContent = 'Connected - Live Data';
                document.querySelector('.live-indicator').style.background = '#26a69a';
            };
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'update' && msg.data) {
                    updateDashboard(msg.data, msg.transactions, msg.bot_logs);
                    updatePriceLogs(msg.price_logs);
                }
            };
            ws.onerror = () => {
                document.getElementById('status').textContent = 'Connection Error';
                document.querySelector('.live-indicator').style.background = '#ef5350';
                setTimeout(connectWebSocket, 5000);
            };
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected - Reconnecting...';
                document.querySelector('.live-indicator').style.background = '#ffa726';
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateDashboard(data, transactions, botLogs) {
            const assets = data.assets || {};
            const coins = Object.keys(assets).slice(0, 6);

            // Only rebuild cards if coins changed OR strategy changed
            const coinsChanged = JSON.stringify(coins) !== JSON.stringify(previousCoins);
            if (coinsChanged) {
                document.getElementById('cards').innerHTML = coins.map(c => createCard(c, assets[c])).join('');
                previousCoins = coins;
                // Init charts after DOM update
                setTimeout(() => initMiniCharts(coins), 50);
            }

            // Store current assets and coins globally for strategy refresh
            window.currentAssets = assets;
            window.currentCoins = coins;

            // Update mini charts with new data
            updateMiniCharts(assets);

            // Update portfolio
            const portfolio = data.portfolio || {};
            const equity = portfolio.equity || 100000;
            const cash = portfolio.cash || 100000;
            const realizedPnl = portfolio.realized_pnl || 0;
            const holdings = portfolio.holdings || {};

            // Calculate unrealized PnL
            let unrealizedPnl = 0;
            Object.values(holdings).forEach(h => {
                unrealizedPnl += (h.current_value || 0) - (h.total_cost || 0);
            });

            const maxDrawdown = portfolio.max_drawdown || 0;
            const openPositions = Object.keys(holdings).length;

            document.getElementById('portfolio-equity').textContent = `$${equity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('cash').textContent = `$${cash.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('equity').textContent = `$${equity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            const pnlEl = document.getElementById('realized-pnl');
            pnlEl.textContent = `${realizedPnl >= 0 ? '+' : ''}$${Math.abs(realizedPnl).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            pnlEl.className = realizedPnl >= 0 ? 'profit' : 'loss';

            const upnlEl = document.getElementById('unrealized-pnl');
            upnlEl.textContent = `${unrealizedPnl >= 0 ? '+' : ''}$${Math.abs(unrealizedPnl).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            upnlEl.className = unrealizedPnl >= 0 ? 'profit' : 'loss';

            document.getElementById('max-drawdown').textContent = `${maxDrawdown.toFixed(2)}%`;
            document.getElementById('open-positions').textContent = openPositions;

            // Update transactions and logs
            updateTransactions(transactions);
            updateBotLogs(botLogs);

            document.getElementById('status').textContent = `Last Update: ${data.timestamp || new Date().toLocaleTimeString()}`;
        }

        window.addEventListener('load', () => {
            connectWebSocket();
            loadCurrentStrategy(); // Initialize strategy toggle state
        });
    </script>
</body>

</html>